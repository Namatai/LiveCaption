<!DOCTYPE html>
<html>
<head>
	<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
	<title>LiveCaption</title>
	<style type='text/css'>
		@import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro);
		
		* {
			margin: 0;
			padding: 5px;
			box-sizing: border-box;
		}

		html {
			-webkit-text-size-adjust: none;
			text-size-adjust: none;
		}
			
		body {
			font-family: Avenir, Helvetica, Arial;
			background: #464646; 
			color: #414141;
		}
		
		.container {
			position: relative;
		}
			
		#divCaptions {
			display: none;
			text-align: center;
			transition: color .5s ease 0s, opacity 0.5s linear;
			font-size: 12vmin;
		}

		#divSelectBridge {
			display: none;
			width: 200px;
			height: 600px;
			font-size: 14px;
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			margin: auto;
			max-width:100%;
			max-height:100%;
		}

		#divGlobalLogo {
			display: flex;
			justify-content: center;
		}

		#selBridgeList {
			font-size: 18px;
			height: 30px;
			width: 200px;
		}

		#divBridgePassword {
			display: none;
		}

		#divLogo {
			opacity: 0;
			transition: opacity 0.5s linear;
			display: none;
			height: 100%;
		}
		
		.imgLogo {
			max-width: 100%;
			max-height: 100vh;
			margin: auto;
		}

		.select-box {
			cursor: pointer;
			position : relative;
			max-width:  30em;
			margin: 5em auto;
			width: 100%;
		}

		.select, .label {
			color: #414141;
			display: block;
			font: 400 17px/2em 'Source Sans Pro', sans-serif;
		}

		.select {
			width: 100%;
			position: absolute;
			top: 0;
			padding: 5px 0;
			height: 40px;
			opacity: 0;
			background: none transparent;
			border: 0 none;
		}
		
		.select-box1 {
			background: #999999;
			width: 200px;
		}

		.label {
			position: relative;
			padding: 5px 10px;
			cursor: pointer;
		}
		
		.open .label::after {
			content: '▲';
		}
		
		.label::after {
			content: '▼';
			font-size: 12px;
			position: absolute;
			right: 0;
			top: 0;
			padding: 5px 15px;
			border-left: 1px solid #464646;
		}
		
		#divLocation {
			position: absolute;
			top: 0px;
			left: 0px;
			height: 45px;
			background: #cccccc;
			width: 100%;
			display: none;
			font: 400 17px/2em 'Source Sans Pro', sans-serif;
		}
		
		#divGoBack {
			position: absolute;
			top: 0px;
			left: 0px;
			cursor: pointer;
			border-right: 1px solid #464646;
			color: #414141;
			background: #999999;
			width: 100px;
			text-align: center;
		}
		
		#divLocationName {
			position: absolute;
			top: 0px;
			right: 5px;
			padding: 5px;
			color: #414141;
			background: #cccccc;
			width: 10%;
			border-left: 1px solid #464646;
			text-align: center;
		}
		
		#divWaiting {
			width: inherit;
			text-align: center;
			position: absolute;
			top: 0px;
			animation: waiting-blink 1.5s ease infinite alternate;
			display: none;
			color: #000000;
			background: #ffffff;
		}

		@keyframes waiting-blink { 
			50% {
				color: #ff0000;
			}
		}
		
		#divAnnouncement {
			width: inherit;
			text-align: center;
			position: absolute;
			top: 0px;
			animation: waiting-blink 1.5s ease infinite alternate;
			display: none;
			color: #000000;
			background: #ffffff;
		}
</style>
	<script src='/socket.io/socket.io.js'></script>
	<script src='lib/nosleep.min.js'></script>
	<script>
	var socket = null;
	var Bridges = [];
	var selectedBridgeID = null;

	var noSleep = new NoSleep();
	var KeepAwake = false;

	var finalTranscript = '';

	function onLoad() {
		document.getElementById('btnLogin').addEventListener('click', function (e) {
			loginBridge(selectedBridgeID, document.getElementById('txtObservePassword').value);
		});
		
		document.getElementById('divGoBack').addEventListener('click', function (e) {
			location.reload();
		});

		socket = io.connect();

		socket.on('connect', function() {
			// Connected, let's sign-up for to receive messages for this room
			socket.emit('room', 'Listeners');
			hideAll();
		});

		socket.on('bridgerooms', function(bridgeArray) {
			Bridges = bridgeArray;
			updateBridgeList();
		});
		
		socket.on('globallogo', function(logo) {
			let imgGlobalLogo = document.createElement('img');
			imgGlobalLogo.src = logo;
			imgGlobalLogo.height = '300';
			document.getElementById('divGlobalLogo').innerHTML = '';
			document.getElementById('divGlobalLogo').appendChild(imgGlobalLogo);
		});

		socket.on('status', function(status) {
			switch(status) {
				case 'success':
					document.getElementById('divSelectBridge').style.display = 'none';
					setStyles();
					GoToLogo(getBridge(selectedBridgeID).logoMode);
					document.title = getBridgeFromID(selectedBridgeID).name;
					showLocationBar();
					document.getElementById('divCaptions').style.display = 'block';
					break;
				case 'failure':
					alert('Incorrect password. Please try again.');
					break;
				default:
					break;
			}
		});

		socket.on('bridgeinuse', function(value) {
			if (value) {
				// Hide the 'waiting' div
				document.getElementById('divWaiting').style.display = 'none';
			}
			else {
				// Show the 'waiting' div
				document.getElementById('divWaiting').style.display = 'block';
				GoToLogo(true);
			} 
		});

		socket.on('announcement', function(text){
			let divAnnouncement = document.getElementById('divAnnouncement');

			if (text !== null) {
				if (text === '') {
					divAnnouncement.style.opacity = '0';
					divAnnouncement.style.display = 'none';
				}
				else {
					if (divAnnouncement.innerHTML === '') {
						divAnnouncement.style.opacity = '0';
						divAnnouncement.style.display = 'block';
						setTimeout(function() {
							divAnnouncement.innerHTML = text.replaceAll('\n','<br>').replaceAll('\r','<br>');
							divAnnouncement.style.opacity = '1';
						}, 500);
					}
					else {
						divAnnouncement.innerHTML = text.replaceAll('\n','<br>').replaceAll('\r','<br>');
						divAnnouncement.style.display = 'block';
						divAnnouncement.style.opacity = '1';
					}
				}
			}
		});

		socket.on('redirect', function(url) {
			window.location.href = url; 
		});

		socket.on('reload', function(value) {
			if (value) {
				window.location.reload(true);
			}
		});
		
		socket.on('clearcaptions', function(value) {
			if (value) {
				let divCaptions = document.getElementById('divCaptions');
				finalTranscript = '';
				divCaptions.innerHTML = '';
			}
		});

		socket.on('caption', function(finalTransmitTranscript, interimTranscript) {
			let divCaptions = document.getElementById('divCaptions');
			finalTranscript += finalTransmitTranscript;
			divCaptions.innerHTML = finalTranscript + '<i style=\'color:#999999;\'>' + interimTranscript + '</i>';
			divCaptions.scrollIntoView({behavior: 'smooth', block: 'end'});
		});

		socket.on('gotologo', function(value) {
			GoToLogo(value);
		});

		socket.on('keepawake', function(value) {
			KeepScreenAwake(value);
		});

		document.addEventListener('click', enableNoSleep, false);
	}
		
	function hideAll() {
		document.getElementById('divLocation').style.display = 'none';
		document.getElementById('divCaptions').style.display = 'none';
		document.getElementById('divLogo').style.display = 'none';
		document.getElementById('divSelectBridge').style.display = 'none';
		
		document.body.style.background = '#464646';
		document.body.style.color = '#414141';
		document.body.style.fontFamily = 'Avenir, Helvetica, Arial';
	}

	String.prototype.replaceAll = function(search, replacement) {
		var target = this;
		return target.split(search).join(replacement);
	};
		
	function showLocationBar() {
		let bridgeName = getBridgeFromID(selectedBridgeID).name;
		
		let divLocation = document.getElementById('divLocation');
		divLocation.style.display = 'block';
		
		let divLocationName = document.getElementById('divLocationName');
		divLocationName.innerHTML = bridgeName;
		
		if (Bridges.length <= 1) {
			document.getElementById('divGoBack').style.display = 'none';
		}
	}

	function updateBridgeList() {
		var selBridgeList = document.getElementById('selBridgeList');
		selBridgeList.options.length = 0;

		if (Bridges.length > 1) { //build a dropdown list of available bridges
			let default_opt = document.createElement('option');
			default_opt.value = '0';
			default_opt.text = '(choose your location)';
			selBridgeList.appendChild(default_opt);
			for (let i = 0; i < Bridges.length; i++) {
				let opt = document.createElement('option');
				opt.value = Bridges[i].id;
				opt.text = Bridges[i].name;
				if (!Bridges[i].inUse) {
					opt.text += ' (offline)';
				}
				selBridgeList.appendChild(opt);
			}
			selBridgeList.setAttribute('onchange', 'selectBridgeFromList();');			
			
			document.getElementById('divSelectBridge').style.display = 'block';
		}
		else if (Bridges.length === 1) { // just load the only one available
			selectBridge(Bridges[0].id);
		}
		else {
			//no bridges are available
			document.getElementById('container').innerHTML = 'No captioning servers are available at this time.';
		}
	}

	function selectBridgeFromList() {
		let sel = document.getElementById('selBridgeList');
		let id = sel.options[sel.selectedIndex].value;
		if (id !== '0') {
			selectBridge(id);
		}
		else {
			document.getElementById('divBridgePassword').style.display = 'none';
		}
	}

	function selectBridge(bridgeID) {
		let bridgeObj = getBridge(bridgeID);
		if (bridgeObj.requiresPassword) {
			document.getElementById('divBridgePassword').style.display = 'block';
		}
		else {
			socket.emit('listener_joinbridgeroom', bridgeID, '');
		}
		selectedBridgeID = bridgeID;
	}

	function getBridgeFromID(bridgeID) {
		return Bridges.find(function (obj) { return obj.id.toString() === bridgeID; });
	}

	function loginBridge(bridgeID, password) {
		socket.emit('listener_joinbridgeroom', bridgeID, password);
	}

	function setStyles() {
		for (let i = 0; i < Bridges.length; i++) {
			if (Bridges[i].id === selectedBridgeID) {
				document.body.style.color = Bridges[i].foregroundColor;
				document.body.style.background = Bridges[i].backgroundColor;
				document.body.style.fontFamily = Bridges[i].font;
				break;
			}
		}
	}

	function getBridge(bridgeID) {
		let bridgeObj = null;

		for (let i = 0; i < Bridges.length; i++) {
			if (Bridges[i].id === bridgeID) {
				bridgeObj = Bridges[i];
			}
		}

		return bridgeObj;
	}

	function GoToLogo(value) {
		if (value) {
			//show logo
			document.getElementById('divCaptions').style.opacity = '0';

			let imgData = getBridge(selectedBridgeID).logo;
			if (imgData !== '') {
				let imgObj = document.createElement('img');
				imgObj.src = imgData;
				imgObj.className = 'imgLogo';
				setTimeout(function() {
					document.getElementById('divLogo').innerHTML = '';
					document.getElementById('divLogo').appendChild(imgObj);
					document.getElementById('divLogo').style.display = 'grid';
					setTimeout(function() {
						document.getElementById('divLogo').style.opacity = '1';
					}, 50);
				}, 500);
			}
		}
		else {
			//hide logo
			document.getElementById('divLogo').style.opacity = '0';
			
			setTimeout(function() {
				document.getElementById('divLogo').style.display = 'none';
				document.getElementById('divCaptions').style.opacity = '1';
			}, 500);

		}
	}

	function KeepScreenAwake(value) { //keeps the phone screen on if true by using the NoSleep library - playing a dummy video in the background
		KeepAwake = value;

		if (!value) {
			noSleep.disable();
		}
	}

	function enableNoSleep() {
		if (KeepAwake) {
			noSleep.enable();
			document.removeEventListener('click', enableNoSleep, false);
		}
	}
	</script>
</head>
<body onLoad='onLoad();'>
	<div id='container'>
		<div id='divLogo'></div>
		<div id='divSelectBridge'>
			<div id='divGlobalLogo'></div>
				<div class='select-box'>
					<label for='selBridgeList' class='label select-box1'><span class='label-desc'>Choose location:</span></label>
					<select id='selBridgeList' class='select'>
						<option>Choose location</option>
					</select>
				</div>   
			<div id='divBridgePassword'>
				<span style='color:#ffffff;'>Password:</span>
				<input type='password' id='txtObservePassword' size='15' />
				<button id='btnLogin'>Login</button>
			</div>
		</div>
		<div id='divLocation'>
			<div id='divWaiting'>WAITING FOR CAPTIONS TO BEGIN...</div>
			<div id='divAnnouncement'></div>
			<div id='divGoBack'>Go Back</div>
			<div id='divLocationName'></div>
		</div>
		<div id='divCaptions'></div>
	</div>
</body>
</html>